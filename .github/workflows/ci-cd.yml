# =========================================
# File: .github/workflows/ci-cd.yml
# Purpose: CI (lint/test) + CD (terraform apply) com OIDC
# =========================================

name: ci-cd                                   # nome do workflow no GitHub

on:                                           # eventos que disparam o workflow
  push:                                       # em push
    branches: [ main ]                        # na branch main
  pull_request:                               # em pull requests
    branches: [ main ]                        # para a branch main
  workflow_dispatch:                          # execução manual pela UI

env:                                          # variáveis globais
  PYTHON_VERSION: "3.12"                      # versão de Python para CI
  TERRAFORM_DIR: "infrastructure/terraform"   # pasta do Terraform

jobs:

  ci:                                         # job de integração contínua
    runs-on: ubuntu-latest                    # runner Linux
    steps:
      - name: Checkout repository             # obtém o código
        uses: actions/checkout@v4

      - name: Set up Python                   # instala Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}   # usa var global

      - name: Install dependencies            # instala deps + linters
        run: |
          python -m pip install --upgrade pip         # atualiza pip
          pip install -r requirements.txt             # deps do projeto
          pip install black pylint pytest bandit      # ferramentas qualidade

      - name: Lint (black)                    # verifica formatação
        run: |
          black --check src scripts || (echo "Run: black src scripts" && exit 1)

      - name: Static analysis (pylint)        # análise estática
        env:
          PYTHONPATH: "${{ github.workspace }}:${{ github.workspace }}/src"  # para imports locais
        run: |
          pylint --errors-only src || (echo "Fix pylint errors" && exit 1)

      - name: Security scan (bandit)          # scan de segurança
        run: |
          bandit -r src -q || (echo "Fix bandit findings" && exit 1)

      - name: Run tests (pytest)              # testes unitários
        env:
          ENV: dev                                     # exemplo de env
          PYTHONPATH: "${{ github.workspace }}:${{ github.workspace }}/src"
        run: |
          pytest -q

  cd:                                         # job de deployment
    needs: ci                                 # só corre se CI passar
    runs-on: ubuntu-latest
    permissions:
      id-token: write                         # OBRIGATÓRIO para OIDC (troca de token)
      contents: read                          # ler o repo

    steps:
      - name: Checkout repository             # obtém o código
        uses: actions/checkout@v4

      # Assume a role na AWS via OIDC (usa secrets do repositório)
      # - role-to-assume: ARN da role criada pelo Terraform (github-actions-deploy-role)
      # - aws-region: região onde estão os teus recursos
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}  # ex.: arn:aws:iam::476114120388:role/github-actions-deploy-role
          aws-region:     ${{ secrets.AWS_REGION }}          # ex.: eu-central-1

      # Passo de debug para ver quem somos na AWS
      - name: Who am I? (debug)
        run: |
          aws sts get-caller-identity                         # mostra conta/role assumida
          aws s3 ls || true                                   # lista buckets (melhor para ver se autenticou)

      # Instalar Terraform (fixar versão ajuda na reprodutibilidade)
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.6

      # Executar Terraform com o backend/config padrão do repositório
      - name: Terraform init/plan/apply
        working-directory: ${{ env.TERRAFORM_DIR }}           # pasta do Terraform
        env:
          TF_VAR_profile: ""                                  # garante que o provider não tenta usar ~/.aws/credentials
        run: |
          terraform init                                      # inicializa providers/backend
          terraform plan -out=tfplan                          # cria um plano (ficheiro tfplan)
          terraform apply -auto-approve tfplan                # aplica o plano sem pedir confirmação
