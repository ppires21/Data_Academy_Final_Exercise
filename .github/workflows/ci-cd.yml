# =========================================
# File: .github/workflows/ci-cd.yml
# Purpose: CI/CD pipeline with import fixes for pylint and
#          safe fallback for missing AWS_REGION secret
# =========================================

name: ci-cd

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  TERRAFORM_DIR: "infrastructure/terraform"
  STATE_MACHINE_NAME: "shopflow-daily-batch"
  STATE_MACHINE_DEF: "workflows/state_machine.yaml"

jobs:

  # ------------------------------
  # Continuous Integration (CI)
  # ------------------------------
  ci:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black pylint pytest bandit

      - name: Lint (black)
        run: |
          black --check src scripts || (echo "Run: black src scripts" && exit 1)

      - name: Static analysis (pylint)
        env:
          PYTHONPATH: "${{ github.workspace }}:${{ github.workspace }}/src"
        run: |
          pylint --errors-only src || (echo "Fix pylint errors" && exit 1)

      - name: Security scan (bandit)
        run: |
          bandit -r src -q || (echo "Fix bandit findings" && exit 1)

      - name: Run tests (pytest)
        env:
          ENV: dev
          PYTHONPATH: "${{ github.workspace }}:${{ github.workspace }}/src"
        run: |
          pytest -q


  # ------------------------------
  # Continuous Deployment (CD)
  # ------------------------------
  cd:
    needs: ci
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug AWS identity
        run: aws sts get-caller-identity


      # ------------------------------------------------------
      # Configure AWS credentials
      # The AWS_REGION secret is optional now — we fall back
      # to eu-west-1 if not provided, avoiding Action failure.
      # ------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          # ✅ Use provided secret if it exists, otherwise default to eu-west-1
          aws-region: ${{ secrets.AWS_REGION || 'eu-west-1' }}

      # Terraform deployment
      - name: Terraform init/plan/apply
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          terraform init
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan

      # Install yq to process YAML
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      # Convert AWS Step Function definition from YAML to JSON
      - name: Convert ASL YAML → JSON
        run: |
          yq -o=json '.' "${{ env.STATE_MACHINE_DEF }}" > /tmp/state_machine.json
          echo "Converted YAML to JSON at /tmp/state_machine.json"

      # Create or update the Step Function state machine
      - name: Create/Update Step Function
        env:
          STATE_MACHINE_ARN: ${{ secrets.STATE_MACHINE_ARN }}
          STATE_MACHINE_ROLE_ARN: ${{ secrets.SFN_ROLE_ARN }}
        run: |
          if [ -z "$STATE_MACHINE_ARN" ]; then
            aws stepfunctions create-state-machine \
              --name "${{ env.STATE_MACHINE_NAME }}" \
              --role-arn "$STATE_MACHINE_ROLE_ARN" \
              --definition file:///tmp/state_machine.json
          else
            aws stepfunctions update-state-machine \
              --state-machine-arn "$STATE_MACHINE_ARN" \
              --definition file:///tmp/state_machine.json \
              --role-arn "$STATE_MACHINE_ROLE_ARN"
          fi

      # Tag release for traceability
      - name: Tag release
        if: github.ref == 'refs/heads/main'
        run: |
          git tag -f "deploy-${GITHUB_SHA::7}"
          git push -f origin "deploy-${GITHUB_SHA::7}"
