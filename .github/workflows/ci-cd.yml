# =========================================
# File: .github/workflows/ci-cd.yml
# Purpose: CI/CD pipeline
#   - CI: lint (black), static analysis (pylint), tests (pytest), security (bandit)
#   - CD: Terraform apply (IAM/SNS/alarms/schedule), deploy Step Functions from YAML
# Requirements:
#   - GitHub secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION
#   - Optional secrets: ALERT_EMAIL (for SNS subscription)
# =========================================

name: ci-cd                                     # Workflow name shown in GitHub UI

on:                                            # Triggers for the workflow
  push:                                        # Run on pushes
    branches: [ main ]                         # Only on main branch
  pull_request:                                # And on PRs
    branches: [ main ]                         # Targeting main
  workflow_dispatch:                           # Allow manual runs

env:                                           # Global env vars for all jobs
  PYTHON_VERSION: "3.12"                       # Python version used in jobs
  TERRAFORM_DIR: "infrastructure/terraform"    # Path to Terraform code
  STATE_MACHINE_NAME: "shopflow-daily-batch"   # Step Functions name used by CD
  STATE_MACHINE_DEF: "workflows/state_machine.yaml"  # YAML definition file path

jobs:

  # ===========================
  #   Continuous Integration
  # ===========================
  ci:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black pylint pytest bandit

      - name: Lint (black)
        run: |
          black --check src scripts || (echo "Run: black src scripts" && exit 1)

      - name: Static analysis (pylint)
        env:
          PYTHONPATH: ${{ github.workspace }}/src   # ✅ FIX: makes imports like config.config_loader work
        run: |
          pylint --errors-only src || (echo "Fix pylint errors" && exit 1)

      - name: Security scan (bandit)
        run: |
          bandit -r src -q || (echo "Fix bandit findings" && exit 1)

      - name: Run tests (pytest)
        env:
          ENV: dev
          PYTHONPATH: ${{ github.workspace }}/src   # ✅ Also needed for imports inside tests
        run: |
          pytest -q


  # ===========================
  #   Continuous Deployment
  # ===========================
  cd:
    needs: ci
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform init/plan/apply
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          terraform init
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Convert ASL YAML → JSON
        run: |
          yq -o=json '.' "${{ env.STATE_MACHINE_DEF }}" > /tmp/state_machine.json
          echo "Converted YAML to JSON at /tmp/state_machine.json"

      - name: Create/Update Step Function
        env:
          STATE_MACHINE_ARN: ${{ secrets.STATE_MACHINE_ARN }}
          STATE_MACHINE_ROLE_ARN: ${{ secrets.SFN_ROLE_ARN }}
        run: |
          if [ -z "$STATE_MACHINE_ARN" ]; then
            aws stepfunctions create-state-machine \
              --name "${{ env.STATE_MACHINE_NAME }}" \
              --role-arn "$STATE_MACHINE_ROLE_ARN" \
              --definition file:///tmp/state_machine.json
          else
            aws stepfunctions update-state-machine \
              --state-machine-arn "$STATE_MACHINE_ARN" \
              --definition file:///tmp/state_machine.json \
              --role-arn "$STATE_MACHINE_ROLE_ARN"
          fi

      - name: Tag release
        if: github.ref == 'refs/heads/main'
        run: |
          git tag -f "deploy-${GITHUB_SHA::7}"
          git push -f origin "deploy-${GITHUB_SHA::7}"
