# =========================================
# File: .github/workflows/ci-cd.yml
# Purpose: CI (lint/test) + CD (terraform apply) com OIDC
# =========================================

name: ci-cd                                      # Nome do workflow

on:                                              # Eventos que disparam o workflow
  push:                                          # Em cada push
    branches: [ main ]                           # ... para a branch main
  pull_request:                                  # Em cada PR
    branches: [ main ]                           # ... que aponta para main
  workflow_dispatch:                             # Permite execução manual no GitHub UI

env:                                             # Variáveis de ambiente globais do job
  PYTHON_VERSION: "3.12"                         # Versão de Python para o CI
  TERRAFORM_DIR: "infrastructure/terraform"      # Diretório do código Terraform

jobs:                                            # Conjunto de jobs do workflow

  ci:                                            # Job de Continuous Integration
    runs-on: ubuntu-latest                       # Runner Ubuntu
    steps:                                       # Passos do job

      - name: Checkout repository                # 1) Fazer checkout do repositório
        uses: actions/checkout@v4                #    Action oficial de checkout

      - name: Set up Python                      # 2) Instalar Python 3.12
        uses: actions/setup-python@v5            #    Action oficial para Python
        with:
          python-version: ${{ env.PYTHON_VERSION }}  #    Versão definida em env

      - name: Install dependencies               # 3) Instalar dependências e linters
        run: |                                   #    Comandos shell multi-linha
          python -m pip install --upgrade pip    #    Atualiza pip
          pip install -r requirements.txt        #    Instala deps do projeto
          pip install black pylint pytest bandit #    Instala ferramentas de qualidade

      - name: Lint (black)                       # 4) Verificar formatação
        run: |                                   #    Se falhar, imprime dica e falha
          black --check src scripts || (echo "Run: black src scripts" && exit 1)

      - name: Static analysis (pylint)           # 5) Análise estática
        env:
          PYTHONPATH: "${{ github.workspace }}:${{ github.workspace }}/src"  # Caminho para imports
        run: |
          pylint --errors-only src || (echo "Fix pylint errors" && exit 1)   # Só erros críticos

      - name: Security scan (bandit)             # 6) Scan de segurança
        run: |
          bandit -r src -q || (echo "Fix bandit findings" && exit 1)         # Fail se encontrar issues

      - name: Run tests (pytest)                 # 7) Executar testes
        env:
          ENV: dev                               #    Variável de ambiente de exemplo
          PYTHONPATH: "${{ github.workspace }}:${{ github.workspace }}/src"
        run: |
          pytest -q                              #    Pytest em modo quiet

  cd:                                            # Job de Continuous Deployment
    needs: ci                                    # Só corre se o job CI tiver sucesso
    runs-on: ubuntu-latest                       # Runner Ubuntu
    permissions:                                 # Permissões que o job precisa
      id-token: write                            # OBRIGATÓRIO para OIDC (assumir role na AWS)
      contents: read                             # Ler conteúdo do repo (checkout)

    steps:                                       # Passos do job CD

      - name: Checkout repository                # 1) Checkout do repositório
        uses: actions/checkout@v4

      - name: Configure AWS credentials          # 2) Assume a role via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}  # ARN da role (define em Secrets)
          aws-region: ${{ secrets.AWS_REGION }}              # Região (define em Secrets)

      - name: Who am I? (debug)                  # 3) Confirmar identidade AWS usada
        run: aws sts get-caller-identity         #    Mostra a conta/role assumida

      - name: Terraform init/plan/apply          # 4) Aplicar o Terraform
        working-directory: ${{ env.TERRAFORM_DIR }} #    Diretório do Terraform
        env:
          TF_VAR_create_events_target: "true"
        run: |                                   #    Pipeline Terraform standard
          terraform init                         #    Inicializa módulos/provedor/backend
          terraform plan -out=tfplan             #    Gera plano e grava em ficheiro
          terraform apply -auto-approve tfplan   #    Aplica o plano sem prompt
